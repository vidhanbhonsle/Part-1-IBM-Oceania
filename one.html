<!DOCTYPE html>
<html>
    <head>
        <title>HERE IBM Oceanic Workshop</title>
        <!-- SCRIPTS -->
        <meta name="viewport" charset="UTF-8" content="initial-scale=1.0, width=device-width" />
        <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
        <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
        <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
        <script type="text/javascript" src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
        <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css"/>
    </head>

    <body>
        <div id="mapContainer" style="width: 98vw; height: 91vh; display: block; margin: 0 auto; border: solid 2px black; margin-top: 5px;" > </div>
        <input type="button" onclick="showDetails()" value = "Show Details" style="width: 200px; height: 30px; border: 2px solid black; display: block; margin: 0 auto; margin-top: 10px;">
        <div id="panel" style="width: 30vw; background: #39B6B3; color: white; margin-top: 20px;display: block; margin: 0 auto;"></div>
    </body>

    <script>
          var platform = new H.service.Platform({
              apikey: "EQAcKacnDczuCuh4U7zFK9buugVgWtubjW9SdZWuG4M"   
          });

          // Obtain the default map types from the platform object
          var defaultLayers = platform.createDefaultLayers();

          var data = "";

          // Get your current position from wego.here.com
          var destinations = { 
            "dest1": {lat: 12.96677,lng: 77.75164}, 
            "dest2": {lat: 12.85677, lng: 77.83164},
            "dest3": {lat: 12.99677, lng: 77.63164},
            "truck": {lat: 12.80677, lng: 77.93164}
            };

          // var positionOne = {lat: 12.96677, lng: 77.75164};
          // var positionTwo = {lat: 12.85677, lng: 77.83164};
          // var positionThree = {lat: 12.99677, lng: 77.63164};
          // var positionFour = {lat: 12.86677, lng: 77.73164};
          // var positionFive = {lat: 12.95677, lng: 77.83164};
          // var positionSix = {lat: 12.84677, lng: 77.63164};
          // var positionSeven = {lat: 12.87677, lng: 77.74164};
          // var positionEight = {lat: 12.95677, lng: 77.78164};
          // var positionNine = {lat: 12.96677, lng: 77.83164};
          // var positionTen = {lat: 12.95677, lng: 77.73164};
          // var positionTruck = {lat: 12.80677, lng: 77.93164};

          // Instantiate (and display) a map object:
          var map = new H.Map(
              document.getElementById('mapContainer'),
              defaultLayers.vector.normal.map,
              {
                  zoom: 12,
                  center: destinations.truck,
                  pixelRatio: window.devicePixelRatio || 1
              });

          window.addEventListener('resize', () => map.getViewPort().resize());
          var ui = H.ui.UI.createDefault(map, defaultLayers, 'en-US');
          var mapEvents = new H.mapevents.MapEvents(map);
          var behavior = new H.mapevents.Behavior(mapEvents);
          
          function setStyle(map){
              // get the vector provider from the base layer
              var provider = map.getBaseLayer().getProvider();
              var style = new H.map.Style('https://heremaps.github.io/maps-api-for-javascript-examples/change-style-at-load/data/dark.yaml',
                'https://js.api.here.com/v3/3.1/styles/omv/');
              // set the style on the existing layer
              provider.setStyle(style);
            }
          setStyle(map);
          
          // Get an instance of the routing service for using the routing API
          // var router = platform.getRoutingService();
          var router = platform.getRoutingService(null, 8);

          // Get an instance of the geocoding and search service:
          var service = platform.getSearchService();
      
          // create an icon for the marker. Choose any image you want. I created mine using draw.io     
          var homeIcon = new H.map.Icon('img/home.png'); 
          var truckIcon = new H.map.Icon('img/truck.png'); 
                  
          // Create a marker using the previously instantiated icon
          var posMarker1 = new H.map.Marker(destinations.dest1,{icon:homeIcon});
          var posMarker2 = new H.map.Marker(destinations.dest2,{icon:homeIcon});
          var posMarker3 = new H.map.Marker(destinations.dest3,{icon:homeIcon});
          // var posMarker4 = new H.map.Marker(positionFour,{icon:homeIcon});
          // var posMarker5 = new H.map.Marker(positionFive,{icon:homeIcon});
          // var posMarker6 = new H.map.Marker(positionSix,{icon:homeIcon});
          // var posMarker7 = new H.map.Marker(positionSeven,{icon:homeIcon});
          // var posMarker8 = new H.map.Marker(positionEight,{icon:homeIcon});
          // var posMarker9 = new H.map.Marker(positionNine,{icon:homeIcon});
          // var posMarker10 = new H.map.Marker(positionTen,{icon:homeIcon});
          var posMarkerTruck = new H.map.Marker(destinations.truck,{icon:truckIcon});
                  
          // Add the marker to the map 
          map.addObject(posMarker1);
          map.addObject(posMarker2);
          map.addObject(posMarker3);
          // map.addObject(posMarker4);
          // map.addObject(posMarker5);
          // map.addObject(posMarker6);
          // map.addObject(posMarker7);
          // map.addObject(posMarker8);
          // map.addObject(posMarker9);
          // map.addObject(posMarker10);
          map.addObject(posMarkerTruck);

          function showDetails(){

            let url = 'https://wse.ls.hereapi.com/2/findsequence.json'+
            '?apiKey=z9vYzze2wci1yOAz6C0bdkQqSb7rkJ0_2oe0_2JK4uY'+
            // destinations[XXXX].lat
            '&start='+destinations["truck"].lat+','+destinations.truck.lng+
            '&destination0='+destinations["dest1"].lat+','+destinations.dest1.lng+
            '&destination1='+destinations["dest2"].lat+','+destinations.dest2.lng+
            '&destination2='+destinations["dest3"].lat+','+destinations.dest3.lng+
            // '&destination3='+positionFour.lat+','+positionFour.lng+
            // '&destination4='+positionFive.lat+','+positionFive.lng+
            // '&destination5='+positionSix.lat+','+positionSix.lng+
            // '&destination6='+positionSeven.lat+','+positionSeven.lng+
            // '&destination7='+positionEight.lat+','+positionEight.lng+
            // '&destination8='+positionNine.lat+','+positionNine.lng+
            // '&destination9='+positionTen.lat+','+positionTen.lng+
            '&mode=fastest;car;traffic:disabled'+
            '&improveFor=time'; 

            async function getapi(url){
              // Storing response 
              const response = await fetch(url); 
              data = await response.json(); 
              // console.log(data);
              // console.log('-----------------------');
              //console.log(typeof data);
            }
            getapi(url);
            // var values = data.results[0].interconnections;
            var values = data.results[0].waypoints;
            console.log(values);
            var origin = null;
            // var destin = null;
            for (i in values){
                // console.log(values[i])
                a = values[i];
                // for (key in a){
                //   console.log(key,a[key]); 
                // } 
              var lat = a['lat'];
              var lng = a['lng'];
              // console.log(lat+"/"+lng);
              if (!origin){
                origin = {lat,lng};
                continue;
              } else{
                var destin = {lat,lng};
                showRoute(origin,destin);
                origin = destin;
                console.log(JSON.stringify(origin) + ':::' + JSON.stringify(destin));
                continue; 
              }
            }
            
        }
function showRoute(origin,destin){
          
        // Create the parameters for the routing request:
        var routingParameters = {
          'routingMode': 'fast',
          'transportMode': 'car',
          // The start point of the route:
          'origin': origin.lat + ',' + origin.lng,
          // The end point of the route:
          'destination': destin.lat + ',' + destin.lng,
          // Include the route shape in the response
          'return': 'polyline'
        };

        // Define a callback function to process the routing response:
        var onResult = function(result) {
          // ensure that at least one route was found
          if (result.routes.length) {
            result.routes[0].sections.forEach((section) => {
                // Create a linestring to use as a point source for the route line
                let linestring = H.geo.LineString.fromFlexiblePolyline(section.polyline);

                // Create a polyline to display the route:
                // let routeLine = new H.map.Polyline(linestring, {
                //   style: { strokeColor: 'red', lineWidth: 3 }
                // });

                // Create an outline for the route polyline:
                var routeOutline = new H.map.Polyline(linestring, {
                  style: {
                    lineWidth: 10,
                    strokeColor: 'rgba(0, 128, 255, 0.7)',
                    lineTailCap: 'arrow-tail',
                    lineHeadCap: 'arrow-head'
                  }
                });
                // Create a patterned polyline:
                var routeArrows = new H.map.Polyline(linestring, {
                  style: {
                    lineWidth: 10,
                    fillColor: 'white',
                    strokeColor: 'rgba(255, 255, 255, 1)',
                    lineDash: [0, 2],
                    lineTailCap: 'arrow-tail',
                    lineHeadCap: 'arrow-head' }
                  }
                );
                // create a group that represents the route line and contains
                // outline and the pattern
                var routeLine = new H.map.Group();
                routeLine.addObjects([routeOutline, routeArrows]);


                // Add the route polyline and the two markers to the map:
                map.addObject(routeLine);

                // Set the map's viewport to make the whole route visible:
                map.getViewModel().setLookAtData({bounds: routeLine.getBoundingBox()});
            
            });
          }
          
        };
        router.calculateRoute(routingParameters, onResult,
  function(error) {
    alert(error.message);
  });
        }
    </script>
</html>